#include <stdio.h>
#include "driver/gpio.h"
#include "freertos/FreeRTOS.h"
#include <sys/time.h>

//A function to specify delays in milliseconds
void delay_ms(int t) {
    vTaskDelay(t /portTICK_PERIOD_MS);
}
#define LED_GPIO GPIO_NUM_10
#define BUTTON GPIO_NUM_4

void app_main(void)
{
    gpio_reset_pin(LED_GPIO);
    gpio_set_direction(LED_GPIO, GPIO_MODE_OUTPUT);
    gpio_reset_pin(BUTTON);
    gpio_set_direction(BUTTON, GPIO_MODE_INPUT);
    gpio_pulldown_en(BUTTON);
    gpio_set_level(LED_GPIO, 0);
    int BSTATE = 0;
    bool LSTATE = false;

   // LED will blink at 2Hz when button is pressed and released.
   // Another press and release turns LED off 
   while (1) {
      switch(BSTATE) {
        case 0: //reset state
        LSTATE = false; //output action
        //next state logic
        if (gpio_get_level(BUTTON)) {
            BSTATE = 1;
        }
        else {
            BSTATE = 0;
        }
        break;

        case 1: 
        if (gpio_get_level(BUTTON)) {
            BSTATE = 1;
        }
        else {
            BSTATE = 2;
        }
        break;

        case 2: 
        LSTATE = !LSTATE;
        delay_ms(250);
        if (gpio_get_level(BUTTON)) {
            BSTATE = 3;
        }
        else {
            BSTATE = 2;
        }
        break;

        case 3: 
        if (gpio_get_level(BUTTON)) {
            BSTATE = 3;
        }
        else {
            BSTATE = 0;
        }
        break;
      }
    gpio_set_level(LED_GPIO, LSTATE);
    delay_ms(10); //for switch bounce
    }
}

